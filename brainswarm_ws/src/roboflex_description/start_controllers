#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/config/real_hardware_controllers.yaml"
CONTROLLER_MANAGER="/controller_manager"

wait_for_manager() {
  until ros2 control list_controllers >/dev/null 2>&1; do
    echo "Waiting for ${CONTROLLER_MANAGER}..."
    sleep 1
  done
}

is_loaded() {
  local name="$1"
  ros2 control list_controllers | awk '{print $1}' | grep -Fxq "${name}"
}

spawn_if_missing() {
  local name="$1"
  if is_loaded "${name}"; then
    echo "${name} already present, skipping."
    return 0
  fi
  echo "Spawning ${name}..."
  ros2 run controller_manager spawner "${name}" \
    -c "${CONTROLLER_MANAGER}" \
    -p "${CONFIG_FILE}"
}

wait_for_manager
spawn_if_missing joint_state_broadcaster
spawn_if_missing arm_controller

echo "Controllers are ready."
